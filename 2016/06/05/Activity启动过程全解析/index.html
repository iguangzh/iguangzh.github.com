<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="学习," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="#Activity启动过程###一些基本的概念

ActivityManagerServices，简称AMS，服务端对象，负责系统中所有Activity的生命周期
ActivityThread，App的真正入口。当开启App之后，会调用main()开始运行，开启消息循环队列，这就是传说中的UI线程或者叫主线程。与ActivityManagerServices配合，一起完成Activity的管理工作">
<meta property="og:type" content="article">
<meta property="og:title" content="Activity启动过程">
<meta property="og:url" content="http://yoursite.com/2016/06/05/Activity启动过程全解析/index.html">
<meta property="og:site_name" content="九月十七">
<meta property="og:description" content="#Activity启动过程###一些基本的概念

ActivityManagerServices，简称AMS，服务端对象，负责系统中所有Activity的生命周期
ActivityThread，App的真正入口。当开启App之后，会调用main()开始运行，开启消息循环队列，这就是传说中的UI线程或者叫主线程。与ActivityManagerServices配合，一起完成Activity的管理工作">
<meta property="og:image" content="http://i11.tietuku.com/15eb948d37d9d4b3.png">
<meta property="og:updated_time" content="2017-02-28T11:30:38.986Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Activity启动过程">
<meta name="twitter:description" content="#Activity启动过程###一些基本的概念

ActivityManagerServices，简称AMS，服务端对象，负责系统中所有Activity的生命周期
ActivityThread，App的真正入口。当开启App之后，会调用main()开始运行，开启消息循环队列，这就是传说中的UI线程或者叫主线程。与ActivityManagerServices配合，一起完成Activity的管理工作">
<meta name="twitter:image" content="http://i11.tietuku.com/15eb948d37d9d4b3.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '6374072520710030000',
      author: '零一'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/06/05/Activity启动过程全解析/"/>





  <title> Activity启动过程 | 九月十七 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d895c3e05dee7508b461c2b655f3206a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">九月十七</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">只要开始就会有新的可能</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            时光机
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/05/Activity启动过程全解析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Guang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="九月十七">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="九月十七" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Activity启动过程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-05T22:10:33+08:00">
                2016-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/06/05/Activity启动过程全解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/05/Activity启动过程全解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Activity启动过程"><a href="#Activity启动过程" class="headerlink" title="#Activity启动过程"></a>#Activity启动过程</h2><p>###一些基本的概念</p>
<ul>
<li>ActivityManagerServices，简称AMS，服务端对象，负责系统中所有Activity的生命周期</li>
<li>ActivityThread，App的真正入口。当开启App之后，会调用main()开始运行，开启消息循环队列，这就是传说中的UI线程或者叫主线程。与ActivityManagerServices配合，一起完成Activity的管理工作</li>
<li>ApplicationThread，用来实现ActivityManagerService与ActivityThread之间的交互。在ActivityManagerService需要管理相关Application中的Activity的生命周期时，通过ApplicationThread的代理对象与ActivityThread通讯。</li>
<li>ApplicationThreadProxy，是ApplicationThread在服务器端的代理，负责和客户端的ApplicationThread通讯。AMS就是通过该代理与ActivityThread进行通信的。</li>
</ul>
<a id="more"></a>
<ul>
<li>Instrumentation，每一个应用程序只有一个Instrumentation对象，每个Activity内都有一个对该对象的引用。Instrumentation可以理解为应用进程的管家，ActivityThread要创建或暂停某个Activity时，都需要通过Instrumentation来进行具体的操作。</li>
<li>ActivityStack，Activity在AMS的栈管理，用来记录已经启动的Activity的先后关系，状态信息等。通过ActivityStack决定是否需要启动新的进程。</li>
<li>ActivityRecord，ActivityStack的管理对象，每个Activity在AMS对应一个* ActivityRecord，来记录Activity的状态以及其他的管理信息。其实就是服务器端的Activity对象的映像。</li>
<li>TaskRecord，AMS抽象出来的一个“任务”的概念，是记录ActivityRecord的栈，一个“Task”包含若干个ActivityRecord。AMS用TaskRecord确保Activity启动和退出的顺序。如果你清楚Activity的4种launchMode，那么对这个概念应该不陌生。</li>
</ul>
<p>###回答一些问题</p>
<p><strong>zygote是什么？有什么作用？</strong></p>
<p>zygote意为“受精卵“。Android是基于Linux系统的，而在Linux中，所有的进程都是由init进程直接或者是间接fork出来的，zygote进程也不例外。</p>
<p>在Android系统里面，zygote是一个进程的名字。Android是基于Linux System的，当你的手机开机的时候，Linux的内核加载完成之后就会启动一个叫“init“的进程。在Linux System里面，所有的进程都是由init进程fork出来的，我们的zygote进程也不例外。</p>
<p>我们都知道，每一个App其实都是</p>
<ul>
<li>一个单独的dalvik虚拟机</li>
<li>一个单独的进程</li>
</ul>
<p>所以当系统里面的第一个zygote进程运行之后，在这之后再开启App，就相当于开启一个新的进程。而为了实现资源共用和更快的启动速度，Android系统开启新进程的方式，是通过fork第一个zygote进程实现的。所以说，除了第一个zygote进程，其他应用所在的进程都是zygote的子进程，这下你明白为什么这个进程叫“受精卵”了吧？因为就像是一个受精卵一样，它能快速的分裂，并且产生遗传物质一样的细胞！</p>
<p><strong>SystemServer是什么？有什么作用？它与zygote的关系是什么？</strong></p>
<p>首先我要告诉你的是，SystemServer也是一个进程，而且是由zygote进程fork出来的。</p>
<p>知道了SystemServer的本质，我们对它就不算太陌生了，这个进程是Android Framework里面两大非常重要的进程之一——另外一个进程就是上面的zygote进程。</p>
<p>为什么说SystemServer非常重要呢？因为系统里面重要的服务都是在这个进程里面开启的，比如<br>ActivityManagerService、PackageManagerService、WindowManagerService等等，看着是不是都挺眼熟的？</p>
<p>那么这些系统服务是怎么开启起来的呢？</p>
<p>在zygote开启的时候，会调用ZygoteInit.main()进行初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">public static void main(String argv[]) &#123;</div><div class="line"></div><div class="line">     ...ignore some code...</div><div class="line"></div><div class="line">    //在加载首个zygote的时候，会传入初始化参数，使得startSystemServer = true</div><div class="line">     boolean startSystemServer = false;</div><div class="line">     for (int i = 1; i &lt; argv.length; i++) &#123;</div><div class="line">                if (&quot;start-system-server&quot;.equals(argv[i])) &#123;</div><div class="line">                    startSystemServer = true;</div><div class="line">                &#125; else if (argv[i].startsWith(ABI_LIST_ARG)) &#123;</div><div class="line">                    abiList = argv[i].substring(ABI_LIST_ARG.length());</div><div class="line">                &#125; else if (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</div><div class="line">                    socketName = argv[i].substring(SOCKET_NAME_ARG.length());</div><div class="line">                &#125; else &#123;</div><div class="line">                    throw new RuntimeException(&quot;Unknown command line argument: &quot; + argv[i]);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ...ignore some code...</div><div class="line"></div><div class="line">         //开始fork我们的SystemServer进程</div><div class="line">     if (startSystemServer) &#123;</div><div class="line">                startSystemServer(abiList, socketName);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">     ...ignore some code...</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们看下startSystemServer()做了些什么</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">/**留着这个注释，就是为了说明SystemServer确实是被fork出来的</div><div class="line"> * Prepare the arguments and fork for the system server process.</div><div class="line"> */</div><div class="line">private static boolean startSystemServer(String abiList, String socketName)</div><div class="line">        throws MethodAndArgsCaller, RuntimeException &#123;</div><div class="line"></div><div class="line">     ...ignore some code...</div><div class="line"></div><div class="line">    //留着这段注释，就是为了说明上面ZygoteInit.main(String argv[])里面的argv就是通过这种方式传递进来的</div><div class="line">    /* Hardcoded command line to start the system server */</div><div class="line">    String args[] = &#123;</div><div class="line">        &quot;--setuid=1000&quot;,</div><div class="line">        &quot;--setgid=1000&quot;,</div><div class="line">        &quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1032,3001,3002,3003,3006,3007&quot;,</div><div class="line">        &quot;--capabilities=&quot; + capabilities + &quot;,&quot; + capabilities,</div><div class="line">        &quot;--runtime-init&quot;,</div><div class="line">        &quot;--nice-name=system_server&quot;,</div><div class="line">        &quot;com.android.server.SystemServer&quot;,</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    int pid;</div><div class="line">    try &#123;</div><div class="line">        parsedArgs = new ZygoteConnection.Arguments(args);</div><div class="line">        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</div><div class="line">        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</div><div class="line"></div><div class="line">    //确实是fuck出来的吧，我没骗你吧~不对，是fork出来的 -_-|||</div><div class="line">        /* Request to fork the system server process */</div><div class="line">        pid = Zygote.forkSystemServer(</div><div class="line">                parsedArgs.uid, parsedArgs.gid,</div><div class="line">                parsedArgs.gids,</div><div class="line">                parsedArgs.debugFlags,</div><div class="line">                null,</div><div class="line">                parsedArgs.permittedCapabilities,</div><div class="line">                parsedArgs.effectiveCapabilities);</div><div class="line">    &#125; catch (IllegalArgumentException ex) &#123;</div><div class="line">        throw new RuntimeException(ex);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* For child process */</div><div class="line">    if (pid == 0) &#123;</div><div class="line">        if (hasSecondZygote(abiList)) &#123;</div><div class="line">            waitForSecondaryZygote(socketName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        handleSystemServerProcess(parsedArgs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ActivityManagerService是什么？什么时候初始化的？有什么作用？</strong></p>
<p>ActivityManagerService，简称AMS，服务端对象，负责系统中所有Activity的生命周期。</p>
<p>ActivityManagerService进行初始化的时机很明确，就是在SystemServer进程开启的时候，就会初始化ActivityManagerService。从下面的代码中可以看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">public final class SystemServer &#123;</div><div class="line"></div><div class="line">    //zygote的主入口</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        new SystemServer().run();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public SystemServer() &#123;</div><div class="line">        // Check for factory test mode.</div><div class="line">        mFactoryTestMode = FactoryTest.getMode();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void run() &#123;</div><div class="line"></div><div class="line">        ...ignore some code...</div><div class="line"></div><div class="line">        //加载本地系统服务库，并进行初始化 </div><div class="line">        System.loadLibrary(&quot;android_servers&quot;);</div><div class="line">        nativeInit();</div><div class="line"></div><div class="line">        // 创建系统上下文</div><div class="line">        createSystemContext();</div><div class="line"></div><div class="line">        //初始化SystemServiceManager对象，下面的系统服务开启都需要调用SystemServiceManager.startService(Class&lt;T&gt;)，这个方法通过反射来启动对应的服务</div><div class="line">        mSystemServiceManager = new SystemServiceManager(mSystemContext);</div><div class="line"></div><div class="line">        //开启服务</div><div class="line">        try &#123;</div><div class="line">            startBootstrapServices();</div><div class="line">            startCoreServices();</div><div class="line">            startOtherServices();</div><div class="line">        &#125; catch (Throwable ex) &#123;</div><div class="line">            Slog.e(&quot;System&quot;, &quot;******************************************&quot;);</div><div class="line">            Slog.e(&quot;System&quot;, &quot;************ Failure starting system services&quot;, ex);</div><div class="line">            throw ex;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ...ignore some code...</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //初始化系统上下文对象mSystemContext，并设置默认的主题,mSystemContext实际上是一个ContextImpl对象。调用ActivityThread.systemMain()的时候，会调用ActivityThread.attach(true)，而在attach()里面，则创建了Application对象，并调用了Application.onCreate()。</div><div class="line">    private void createSystemContext() &#123;</div><div class="line">        ActivityThread activityThread = ActivityThread.systemMain();</div><div class="line">        mSystemContext = activityThread.getSystemContext();</div><div class="line">        mSystemContext.setTheme(android.R.style.Theme_DeviceDefault_Light_DarkActionBar);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //在这里开启了几个核心的服务，因为这些服务之间相互依赖，所以都放在了这个方法里面。</div><div class="line">    private void startBootstrapServices() &#123;</div><div class="line"></div><div class="line">        ...ignore some code...</div><div class="line"></div><div class="line">        //初始化ActivityManagerService</div><div class="line">        mActivityManagerService = mSystemServiceManager.startService(</div><div class="line">                ActivityManagerService.Lifecycle.class).getService();</div><div class="line">        mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</div><div class="line"></div><div class="line">        //初始化PowerManagerService，因为其他服务需要依赖这个Service，因此需要尽快的初始化</div><div class="line">        mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);</div><div class="line"></div><div class="line">        // 现在电源管理已经开启，ActivityManagerService负责电源管理功能</div><div class="line">        mActivityManagerService.initPowerManagement();</div><div class="line"></div><div class="line">        // 初始化DisplayManagerService</div><div class="line">        mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class);</div><div class="line"></div><div class="line">    //初始化PackageManagerService</div><div class="line">    mPackageManagerService = PackageManagerService.main(mSystemContext, mInstaller,</div><div class="line">       mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</div><div class="line"></div><div class="line">    ...ignore some code...</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>经过上面这些步骤，我们的ActivityManagerService对象已经创建好了，并且完成了成员变量初始化。而且在这之前，调用createSystemContext()创建系统上下文的时候，也已经完成了mSystemContext和ActivityThread的创建。注意，这是系统进程开启时的流程，在这之后，会开启系统的Launcher程序，完成系统界面的加载与显示。</p>
<p>你是否会好奇，我为什么说AMS是服务端对象？下面我给你介绍下Android系统里面的服务器和客户端的概念。</p>
<p>其实服务器客户端的概念不仅仅存在于Web开发中，在Android的框架设计中，使用的也是这一种模式。服务器端指的就是所有App共用的系统服务，比如我们这里提到的ActivityManagerService，和前面提到的PackageManagerService、WindowManagerService等等，这些基础的系统服务是被所有的App公用的，当某个App想实现某个操作的时候，要告诉这些系统服务，比如你想打开一个App，那么我们知道了包名和MainActivity类名之后就可以打开</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Intent intent = new Intent(Intent.ACTION_MAIN);  </div><div class="line">intent.addCategory(Intent.CATEGORY_LAUNCHER);              </div><div class="line">ComponentName cn = new ComponentName(packageName, className);              </div><div class="line">intent.setComponent(cn);  </div><div class="line">startActivity(intent);</div></pre></td></tr></table></figure>
<p>但是，我们的App通过调用startActivity()并不能直接打开另外一个App，这个方法会通过一系列的调用，最后还是告诉AMS说：“我要打开这个App，我知道他的住址和名字，你帮我打开吧！”所以是AMS来通知zygote进程来fork一个新进程，来开启我们的目标App的。这就像是浏览器想要打开一个超链接一样，浏览器把网页地址发送给服务器，然后还是服务器把需要的资源文件发送给客户端的。</p>
<p>知道了Android Framework的客户端服务器架构之后，我们还需要了解一件事情，那就是我们的App和AMS(SystemServer进程)还有zygote进程分属于三个独立的进程，他们之间如何通信呢？</p>
<p>知道了Android Framework的客户端服务器架构之后，我们还需要了解一件事情，那就是我们的App和AMS(SystemServer进程)还有zygote进程分属于三个独立的进程，他们之间如何通信呢？</p>
<p>App与AMS通过Binder进行IPC通信，AMS(SystemServer进程)与zygote通过Socket进行IPC通信。</p>
<p>那么AMS有什么用呢？在前面我们知道了，如果想打开一个App的话，需要AMS去通知zygote进程，除此之外，其实所有的Activity的开启、暂停、关闭都需要AMS来控制，所以我们说，AMS负责系统中所有Activity的生命周期。</p>
<p>在Android系统中，任何一个Activity的启动都是由AMS和应用程序进程（主要是ActivityThread）相互配合来完成的。AMS服务统一调度系统中所有进程的Activity启动，而每个Activity的启动过程则由其所属的进程具体来完成。</p>
<p>这样说你可能还是觉得比较抽象，没关系，下面有一部分是专门来介绍AMS与ActivityThread如何一起合作控制Activity的生命周期的。</p>
<p><strong>Launcher是什么？什么时候启动的？</strong></p>
<p>当我们点击手机桌面上的图标的时候，App就由Launcher开始启动了。但是，你有没有思考过Launcher到底是一个什么东西？</p>
<p>Launcher本质上也是一个应用程序，和我们的App一样，也是继承自Activity</p>
<p>packages/apps/Launcher2/src/com/android/launcher2/Launcher.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public final class Launcher extends Activity</div><div class="line">        implements View.OnClickListener, OnLongClickListener, LauncherModel.Callbacks,</div><div class="line">                   View.OnTouchListener &#123;</div><div class="line">                   &#125;</div></pre></td></tr></table></figure>
<p>Launcher实现了点击、长按等回调接口，来接收用户的输入。既然是普通的App，那么我们的开发经验在这里就仍然适用，比如，我们点击图标的时候，是怎么开启的应用呢？如果让你，你怎么做这个功能呢？捕捉图标点击事件，然后startActivity()发送对应的Intent请求呗！是的，Launcher也是这么做的，就是这么easy！</p>
<p>那么到底是处理的哪个对象的点击事件呢？既然Launcher是App，并且有界面，那么肯定有布局文件呀，是的，我找到了布局文件launcher.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">&lt;FrameLayout</div><div class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:launcher=&quot;http://schemas.android.com/apk/res/com.android.launcher&quot;</div><div class="line">    android:id=&quot;@+id/launcher&quot;&gt;</div><div class="line"></div><div class="line">    &lt;com.android.launcher2.DragLayer</div><div class="line">        android:id=&quot;@+id/drag_layer&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;</div><div class="line">        android:fitsSystemWindows=&quot;true&quot;&gt;</div><div class="line"></div><div class="line">        &lt;!-- Keep these behind the workspace so that they are not visible when</div><div class="line">             we go into AllApps --&gt;</div><div class="line">        &lt;include</div><div class="line">            android:id=&quot;@+id/dock_divider&quot;</div><div class="line">            layout=&quot;@layout/workspace_divider&quot;</div><div class="line">            android:layout_marginBottom=&quot;@dimen/button_bar_height&quot;</div><div class="line">            android:layout_gravity=&quot;bottom&quot; /&gt;</div><div class="line"></div><div class="line">        &lt;include</div><div class="line">            android:id=&quot;@+id/paged_view_indicator&quot;</div><div class="line">            layout=&quot;@layout/scroll_indicator&quot;</div><div class="line">            android:layout_gravity=&quot;bottom&quot;</div><div class="line">            android:layout_marginBottom=&quot;@dimen/button_bar_height&quot; /&gt;</div><div class="line"></div><div class="line">        &lt;!-- The workspace contains 5 screens of cells --&gt;</div><div class="line">        &lt;com.android.launcher2.Workspace</div><div class="line">            android:id=&quot;@+id/workspace&quot;</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;match_parent&quot;</div><div class="line">            android:paddingStart=&quot;@dimen/workspace_left_padding&quot;</div><div class="line">            android:paddingEnd=&quot;@dimen/workspace_right_padding&quot;</div><div class="line">            android:paddingTop=&quot;@dimen/workspace_top_padding&quot;</div><div class="line">            android:paddingBottom=&quot;@dimen/workspace_bottom_padding&quot;</div><div class="line">            launcher:defaultScreen=&quot;2&quot;</div><div class="line">            launcher:cellCountX=&quot;@integer/cell_count_x&quot;</div><div class="line">            launcher:cellCountY=&quot;@integer/cell_count_y&quot;</div><div class="line">            launcher:pageSpacing=&quot;@dimen/workspace_page_spacing&quot;</div><div class="line">            launcher:scrollIndicatorPaddingLeft=&quot;@dimen/workspace_divider_padding_left&quot;</div><div class="line">            launcher:scrollIndicatorPaddingRight=&quot;@dimen/workspace_divider_padding_right&quot;&gt;</div><div class="line"></div><div class="line">            &lt;include android:id=&quot;@+id/cell1&quot; layout=&quot;@layout/workspace_screen&quot; /&gt;</div><div class="line">            &lt;include android:id=&quot;@+id/cell2&quot; layout=&quot;@layout/workspace_screen&quot; /&gt;</div><div class="line">            &lt;include android:id=&quot;@+id/cell3&quot; layout=&quot;@layout/workspace_screen&quot; /&gt;</div><div class="line">            &lt;include android:id=&quot;@+id/cell4&quot; layout=&quot;@layout/workspace_screen&quot; /&gt;</div><div class="line">            &lt;include android:id=&quot;@+id/cell5&quot; layout=&quot;@layout/workspace_screen&quot; /&gt;</div><div class="line">        &lt;/com.android.launcher2.Workspace&gt;</div><div class="line"></div><div class="line">    ...ignore some code...</div><div class="line"></div><div class="line">    &lt;/com.android.launcher2.DragLayer&gt;</div><div class="line">&lt;/FrameLayout&gt;</div></pre></td></tr></table></figure>
<p>为了方便查看，我删除了很多代码，从上面这些我们应该可以看出一些东西来：Launcher大量使用标签来实现界面的复用，而且定义了很多的自定义控件实现界面效果，dock_divider从布局的参数声明上可以猜出，是底部操作栏和上面图标布局的分割线，而paged_view_indicator则是页面指示器，和App首次进入的引导页下面的界面引导是一样的道理。当然，我们最关心的是Workspace这个布局，因为注释里面说在这里面包含了5个屏幕的单元格，想必你也猜到了，这个就是在首页存放我们图标的那五个界面(不同的ROM会做不同的DIY，数量不固定)。</p>
<p>接下来，我们应该打开workspace_screen布局，看看里面有什么东东。</p>
<p>workspace_screen.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;com.android.launcher2.CellLayout</div><div class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:launcher=&quot;http://schemas.android.com/apk/res/com.android.launcher&quot;</div><div class="line">    android:layout_width=&quot;wrap_content&quot;</div><div class="line">    android:layout_height=&quot;wrap_content&quot;</div><div class="line">    android:paddingStart=&quot;@dimen/cell_layout_left_padding&quot;</div><div class="line">    android:paddingEnd=&quot;@dimen/cell_layout_right_padding&quot;</div><div class="line">    android:paddingTop=&quot;@dimen/cell_layout_top_padding&quot;</div><div class="line">    android:paddingBottom=&quot;@dimen/cell_layout_bottom_padding&quot;</div><div class="line">    android:hapticFeedbackEnabled=&quot;false&quot;</div><div class="line">    launcher:cellWidth=&quot;@dimen/workspace_cell_width&quot;</div><div class="line">    launcher:cellHeight=&quot;@dimen/workspace_cell_height&quot;</div><div class="line">    launcher:widthGap=&quot;@dimen/workspace_width_gap&quot;</div><div class="line">    launcher:heightGap=&quot;@dimen/workspace_height_gap&quot;</div><div class="line">    launcher:maxGap=&quot;@dimen/workspace_max_gap&quot; /&gt;</div></pre></td></tr></table></figure>
<p>里面就一个CellLayout，也是一个自定义布局，那么我们就可以猜到了，既然可以存放图标，那么这个自定义的布局很有可能是继承自ViewGroup或者是其子类，实际上，CellLayout确实是继承自ViewGroup。在CellLayout里面，只放了一个子View，那就是ShortcutAndWidgetContainer。从名字也可以看出来，ShortcutAndWidgetContainer这个类就是用来存放快捷图标和Widget小部件的，那么里面放的是什么对象呢？</p>
<p>在桌面上的图标，使用的是BubbleTextView对象，这个对象在TextView的基础之上，添加了一些特效，比如你长按移动图标的时候，图标位置会出现一个背景(不同版本的效果不同)，所以我们找到BubbleTextView对象的点击事件，就可以找到Launcher如何开启一个App了。</p>
<p>除了在桌面上有图标之外，在程序列表中点击图标，也可以开启对应的程序。这里的图标使用的不是BubbleTextView对象，而是PagedViewIcon对象，我们如果找到它的点击事件，就也可以找到Launcher如何开启一个App。</p>
<p>其实说这么多，和今天的主题隔着十万八千里，上面这些东西，你有兴趣就看，没兴趣就直接跳过，不知道不影响这篇文章阅读。</p>
<p>BubbleTextView的点击事件在哪里呢？我来告诉你：在Launcher.onClick(View v)里面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">     * Launches the intent referred by the clicked shortcut</div><div class="line">     */</div><div class="line">    public void onClick(View v) &#123;</div><div class="line"></div><div class="line">          ...ignore some code...</div><div class="line"></div><div class="line">         Object tag = v.getTag();</div><div class="line">        if (tag instanceof ShortcutInfo) &#123;</div><div class="line">            // Open shortcut</div><div class="line">            final Intent intent = ((ShortcutInfo) tag).intent;</div><div class="line">            int[] pos = new int[2];</div><div class="line">            v.getLocationOnScreen(pos);</div><div class="line">            intent.setSourceBounds(new Rect(pos[0], pos[1],</div><div class="line">                    pos[0] + v.getWidth(), pos[1] + v.getHeight()));</div><div class="line">        //开始开启Activity咯~</div><div class="line">            boolean success = startActivitySafely(v, intent, tag);</div><div class="line"></div><div class="line">            if (success &amp;&amp; v instanceof BubbleTextView) &#123;</div><div class="line">                mWaitingForResume = (BubbleTextView) v;</div><div class="line">                mWaitingForResume.setStayPressed(true);</div><div class="line">            &#125;</div><div class="line">        &#125; else if (tag instanceof FolderInfo) &#123;</div><div class="line">            //如果点击的是图标文件夹，就打开文件夹</div><div class="line">            if (v instanceof FolderIcon) &#123;</div><div class="line">                FolderIcon fi = (FolderIcon) v;</div><div class="line">                handleFolderClick(fi);</div><div class="line">            &#125;</div><div class="line">        &#125; else if (v == mAllAppsButton) &#123;</div><div class="line">        ...ignore some code...</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从上面的代码我们可以看到，在桌面上点击快捷图标的时候，会调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">startActivitySafely(v, intent, tag);</div></pre></td></tr></table></figure>
<p>那么从程序列表界面，点击图标的时候会发生什么呢？实际上，程序列表界面使用的是AppsCustomizePagedView对象，所以我在这个类里面找到了onClick(View v)。</p>
<p>com.android.launcher2.AppsCustomizePagedView.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * The Apps/Customize page that displays all the applications, widgets, and shortcuts.</div><div class="line"> */</div><div class="line">public class AppsCustomizePagedView extends PagedViewWithDraggableItems implements</div><div class="line">        View.OnClickListener, View.OnKeyListener, DragSource,</div><div class="line">        PagedViewIcon.PressedCallback, PagedViewWidget.ShortPressListener,</div><div class="line">        LauncherTransitionable &#123;</div><div class="line"></div><div class="line">     @Override</div><div class="line">    public void onClick(View v) &#123;</div><div class="line"></div><div class="line">         ...ignore some code...</div><div class="line"></div><div class="line">        if (v instanceof PagedViewIcon) &#123;</div><div class="line">            mLauncher.updateWallpaperVisibility(true);</div><div class="line">            mLauncher.startActivitySafely(v, appInfo.intent, appInfo);</div><div class="line">        &#125; else if (v instanceof PagedViewWidget) &#123;</div><div class="line">                 ...ignore some code..</div><div class="line">         &#125;</div><div class="line">     &#125;      </div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到，调用的是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mLauncher.startActivitySafely(v, appInfo.intent, appInfo);</div></pre></td></tr></table></figure>
<p>殊途同归</p>
<p>不管从哪里点击图标，调用的都是Launcher.startActivitySafely()。</p>
<p>下面我们就可以一步步的来看一下Launcher.startActivitySafely()到底做了什么事情。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">boolean startActivitySafely(View v, Intent intent, Object tag) &#123;</div><div class="line">       boolean success = false;</div><div class="line">       try &#123;</div><div class="line">           success = startActivity(v, intent, tag);</div><div class="line">       &#125; catch (ActivityNotFoundException e) &#123;</div><div class="line">           Toast.makeText(this, R.string.activity_not_found, Toast.LENGTH_SHORT).show();</div><div class="line">           Log.e(TAG, &quot;Unable to launch. tag=&quot; + tag + &quot; intent=&quot; + intent, e);</div><div class="line">       &#125;</div><div class="line">       return success;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>调用了startActivity(v, intent, tag)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">boolean startActivity(View v, Intent intent, Object tag) &#123;</div><div class="line"></div><div class="line">       intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">       try &#123;</div><div class="line">           boolean useLaunchAnimation = (v != null) &amp;&amp;</div><div class="line">                   !intent.hasExtra(INTENT_EXTRA_IGNORE_LAUNCH_ANIMATION);</div><div class="line"></div><div class="line">           if (useLaunchAnimation) &#123;</div><div class="line">               if (user == null || user.equals(android.os.Process.myUserHandle())) &#123;</div><div class="line">                   startActivity(intent, opts.toBundle());</div><div class="line">               &#125; else &#123;</div><div class="line">                   launcherApps.startMainActivity(intent.getComponent(), user,</div><div class="line">                           intent.getSourceBounds(),</div><div class="line">                           opts.toBundle());</div><div class="line">               &#125;</div><div class="line">           &#125; else &#123;</div><div class="line">               if (user == null || user.equals(android.os.Process.myUserHandle())) &#123;</div><div class="line">                   startActivity(intent);</div><div class="line">               &#125; else &#123;</div><div class="line">                   launcherApps.startMainActivity(intent.getComponent(), user,</div><div class="line">                           intent.getSourceBounds(), null);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           return true;</div><div class="line">       &#125; catch (SecurityException e) &#123;</div><div class="line">       ...</div><div class="line">       &#125;</div><div class="line">       return false;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这里会调用Activity.startActivity(intent, opts.toBundle())，这个方法熟悉吗？这就是我们经常用到的Activity.startActivity(Intent)的重载函数。而且由于设置了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div></pre></td></tr></table></figure>
<p>所以这个Activity会添加到一个新的Task栈中，而且，startActivity()调用的其实是startActivityForResult()这个方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">    public void startActivity(Intent intent, @Nullable Bundle options) &#123;</div><div class="line">        if (options != null) &#123;</div><div class="line">            startActivityForResult(intent, -1, options);</div><div class="line">        &#125; else &#123;</div><div class="line">            // Note we want to go through this call for compatibility with</div><div class="line">            // applications that may have overridden the method.</div><div class="line">            startActivityForResult(intent, -1);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>所以我们现在明确了，Launcher中开启一个App，其实和我们在Activity中直接startActivity()基本一样，都是调用了Activity.startActivityForResult()。</p>
<p><strong>Instrumentation是什么？和ActivityThread是什么关系？</strong></p>
<p>还记得前面说过的Instrumentation对象吗？每个Activity都持有Instrumentation对象的一个引用，但是整个进程只会存在一个Instrumentation对象。当startActivityForResult()调用之后，实际上还是调用了mInstrumentation.execStartActivity()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public void startActivityForResult(Intent intent, int requestCode, @Nullable Bundle options) &#123;</div><div class="line">        if (mParent == null) &#123;</div><div class="line">            Instrumentation.ActivityResult ar =</div><div class="line">                mInstrumentation.execStartActivity(</div><div class="line">                    this, mMainThread.getApplicationThread(), mToken, this,</div><div class="line">                    intent, requestCode, options);</div><div class="line">            if (ar != null) &#123;</div><div class="line">                mMainThread.sendActivityResult(</div><div class="line">                    mToken, mEmbeddedID, requestCode, ar.getResultCode(),</div><div class="line">                    ar.getResultData());</div><div class="line">            &#125;</div><div class="line">            ...ignore some code...    </div><div class="line">        &#125; else &#123;</div><div class="line">            if (options != null) &#123;</div><div class="line">                 //当现在的Activity有父Activity的时候会调用，但是在startActivityFromChild()内部实际还是调用的mInstrumentation.execStartActivity()</div><div class="line">                mParent.startActivityFromChild(this, intent, requestCode, options);</div><div class="line">            &#125; else &#123;</div><div class="line">                mParent.startActivityFromChild(this, intent, requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">         ...ignore some code...    </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>下面是mInstrumentation.execStartActivity()的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public ActivityResult execStartActivity(</div><div class="line">            Context who, IBinder contextThread, IBinder token, Activity target,</div><div class="line">            Intent intent, int requestCode, Bundle options) &#123;</div><div class="line">        IApplicationThread whoThread = (IApplicationThread) contextThread;</div><div class="line">            ...ignore some code...</div><div class="line">      try &#123;</div><div class="line">            intent.migrateExtraStreamToClipData();</div><div class="line">            intent.prepareToLeaveProcess();</div><div class="line">            int result = ActivityManagerNative.getDefault()</div><div class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</div><div class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</div><div class="line">                        token, target != null ? target.mEmbeddedID : null,</div><div class="line">                        requestCode, 0, null, options);</div><div class="line">            checkStartActivityResult(result, intent);</div><div class="line">        &#125; catch (RemoteException e) &#123;</div><div class="line">        &#125;</div><div class="line">        return null;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>所以当我们在程序中调用startActivity()的 时候，实际上调用的是Instrumentation的相关的方法。</p>
<p>Instrumentation意为“仪器”，我们先看一下这个类里面包含哪些方法吧</p>
<p><img src="http://i11.tietuku.com/15eb948d37d9d4b3.png" alt=""></p>
<p>我们可以看到，这个类里面的方法大多数和Application和Activity有关，是的，这个类就是完成对Application和Activity初始化和生命周期的工具类。比如说，我单独挑一个callActivityOnCreate()让你看看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public void callActivityOnCreate(Activity activity, Bundle icicle) &#123;</div><div class="line">        prePerformCreate(activity);</div><div class="line">        activity.performCreate(icicle);</div><div class="line">        postPerformCreate(activity);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>对activity.performCreate(icicle);这一行代码熟悉吗？这一行里面就调用了传说中的Activity的入口函数onCreate()，不信？接着往下看</p>
<p>Activity.performCreate()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">final void performCreate(Bundle icicle) &#123;</div><div class="line">        onCreate(icicle);</div><div class="line">        mActivityTransitionState.readState(icicle);</div><div class="line">        performCreateCommon();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>没骗你吧，onCreate在这里调用了吧。但是有一件事情必须说清楚，那就是这个Instrumentation类这么重要，为啥我在开发的过程中，没有发现他的踪迹呢？</p>
<p>是的，Instrumentation这个类很重要，对Activity生命周期方法的调用根本就离不开他，他可以说是一个大管家，但是，这个大管家比较害羞，是一个女的，管内不管外，是老板娘~</p>
<p>那么你可能要问了，老板是谁呀？<br>老板当然是大名鼎鼎的ActivityThread了！</p>
<p>ActivityThread你都没听说过？那你肯定听说过传说中的UI线程吧？是的，这就是UI线程。我们前面说过，App和AMS是通过Binder传递信息的，那么ActivityThread就是专门与AMS的外交工作的。</p>
<p>AMS说：“ActivityThread，你给我暂停一个Activity！”<br>ActivityThread就说：“没问题！”然后转身和Instrumentation说：“老婆，AMS让暂停一个Activity，我这里忙着呢，你快去帮我把这事办了把~”<br>于是，Instrumentation就去把事儿搞定了。</p>
<p>所以说，AMS是董事会，负责指挥和调度的，ActivityThread是老板，虽然说家里的事自己说了算，但是需要听从AMS的指挥，而Instrumentation则是老板娘，负责家里的大事小事，但是一般不抛头露面，听一家之主ActivityThread的安排。</p>
<p><strong>如何理解AMS和ActivityThread之间的Binder通信？</strong></p>
<p>前面我们说到，在调用startActivity()的时候，实际上调用的是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mInstrumentation.execStartActivity()</div></pre></td></tr></table></figure>
<p>但是到这里还没完呢！里面又调用了下面的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ActivityManagerNative.getDefault()</div><div class="line">                .startActivity</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay.png" alt="Guang WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay.png" alt="Guang Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/学习/" rel="tag"># 学习</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/06/03/Intent/" rel="next" title="Intent在Activity之间穿梭">
                <i class="fa fa-chevron-left"></i> Intent在Activity之间穿梭
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/06/20/Git操作/" rel="prev" title="Git操作">
                Git操作 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/06/05/Activity启动过程全解析/"
           data-title="Activity启动过程" data-url="http://yoursite.com/2016/06/05/Activity启动过程全解析/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Guang" />
          <p class="site-author-name" itemprop="name">Guang</p>
          <p class="site-description motion-element" itemprop="description">唯一不变的，就是变化</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/iguangzh" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Activity启动过程"><span class="nav-number">1.</span> <span class="nav-text">#Activity启动过程</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Guang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"iguangzh"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  












  
  

  

  

  

  


</body>
</html>
